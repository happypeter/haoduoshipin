SPV ，"简单支付验证“，是中本聪在比特币白皮书里面专门介绍的概念，本身其实很简单，但是要事先对区块结构，Merkle Tree 和哈希的概念有理解。Merkle Tree 和哈希这两个概念，之前 Peter 分别写文章介绍过了，所以本文中默认你已经掌握了，但是对区块结构我们还是会详细介绍的。

## 区块结构

所以我们先来看看区块结构，这是理解 SPV 的基础。

一个区块主要由两部分组成，一个是“区块头”（ Block Headers )，一个是“区块体”（ Block Body ) 。区块头中包含的是关于本区块的一些信息，例如版本号，随机数，挖矿难度等等，其中“前一个区块的哈希”这个是比较有意思的，因为各个区块就是靠这个信息连成一条链的。注意，这里的前一个区块的哈希，其实不是把整个区块数据拿出来算哈希，而只是区块头的哈希。

![](https://img.haoqicat.com/2018100901.jpg)


区块头中另外一项，Merkle 根，是我们更加感兴趣的一个参数。有 Merkle 根，必定对应一个 Merkle 树，必定对应着很多个小数据。没错，每一个小数据就都是一个交易。每个区块中一般都会包含2000多个交易，这些交易的数据并不在区块头中，而是保存在区块体中。注意，区块体中的并没有保存 Merkle 树，区块头中也没有，所以每次如果用到 Markle 树，需要重新运算一下。运算出来的 Merkle 根，就是最终被保存到区块头中的 Merkle 根。

![](https://img.haoqicat.com/2018100902.jpg)

理解了区块结构，就可以理解全节点（ Full Node ）和轻客户端（ Thin Client ) 的区别了。全节点是一个程序，例如中本聪自己写的 Bitcoin Coin ，这个程序运行起来之后，会把整条区块链都下载到本地。比特币的区块数据估计到18年底会到达173G ，不算太大，但是要在手机上跑全节点基本是不可能的。所以有轻客户端的概念，例如 Electrum 就是个轻客户端。轻客户端可以安装在电脑上也可以安装在手机上，为啥呢？因为轻客户端只会去下载区块头，每个区块头只有80K，所以一条区块头组成的链，只有几十兆。

SPV 就是一个在轻客户端环境下，验证交易有效性的过程。

## SPV 验证过程

安装全节点，很多时候是因为我们要挖矿。而安装轻客户端，通常就是把它当成一个钱包软件用。SPV 要解决的就是在轻客户端条件下的支付确认问题。

钱包当然就是用来负责当前账户的转入和转出操作的。先说转出，轻客户端能构建交易，并且签名交易，再广播到全网，这就是转出操作了。再说转入，网上交易很多，但是轻客户端只会去下载跟自己的账户相关的交易。那么不管是转入还是转出交易，下载到轻客户端本地都是相对孤立的交易，因为本地没有保存区块体。那么如何去验证交易生效了呢？这就是 SPV 要解决的问题。我们知道，一个交易在区块链上生效，意味着要满足两个条件：一个是交易已经被打包到了某个区块中，另外一个是这个区块之上又继续打包了5个区块，也就是所谓的要六次确认。

但是，毕竟轻客户端这里是没有保存任何交易的，所以一个独立的交易拿出来，要确定它属于哪个区块也是不可能的。这时候轻客户端需要发起 SPV 过程。首先，轻客户端要发起一个专门的确认请求，把这个交易广播给网络上邻近的全节点。全节点收到交易后，会去搜索这个交易属于哪个区块，然后会运算这个区块的 Merkle Tree 。这时， Merkle Tree 最大的优势现在就发挥出来了，因为要确认一个交易是不是从属于一个 Merkle 根，是不需要把整个 Merkle Tree 都发送给轻节点的，而只需要发送跟当前交易相关的部分 Merkle 树即可。这样，轻节点接收到这个部分 Merkle 树之后，在自己本地在运算一下这个交易的哈希，然后根据部分 Merkle 树上的各个哈希值，一路运算获得 Merkle 根，如果这个值跟自己的区块头中的正好吻合，交易验证就成功了。

所以整个 SPV 过程是靠全节点帮忙去验证交易的，轻节点自身不能验证交易，但是通过确认其他全节点都接受了这次交易，就间接完成了交易确认。但是，全节点有没有可能反馈一个假的 Merkle Tree 过来呢？答案是不可能。在 Merkle 验证中用一个伪造的交易哈希来得到一个已知的 Merkle 根是不可能的。比特币计算 Merkle 树哈希使用的是 sha256 算法，伪造就相当于去碰撞 sha256 算法了，这是根本不可能的。

## SPV 有什么用处？

那么中本聪引入 SPV 技术到底有没有实际用途呢？

首先一个就是用来实现钱包软件。如果一个钱包软件想要安装在移动设备上，想要避免去下载一百多 G 的区块数据。那么就只有两个思路，一个是借助中心化服务器，让钱包去把信息先发送到服务器，然后由服务器去验证交易，这样的思路显然就偏中心化了。另外一个思路就是 SPV ，类似 Electrum 这样的钱包，就可以通过只下载区块头来验证交易，整个的数据量和计算量都是不大的，可以直接运行在低端设备上。所以很多轻客户端，也叫轻钱包，或者叫 SPV 钱包。

SPV 的另外一个用途就是实现侧链技术。侧链就是可以通过双向锚定来使用主链上的币的一条链，上面可以做出各种创新。例如基于比特币的侧链开发出的 RootStock ，可以基于比特币实现智能合约平台。而双向锚定过程，就依赖于 SPV 技术。

所以，虽然 SPV 在白皮书上所占的篇幅不大，但是实际中发挥的作用是非常大的。

## 总结 

最后来总结一下，有这么几点 Peter 觉得是最重要的：第一，区块有区块头和区块体组成，区块头中的前一个区块的哈希，其实就是之前一个区块的区块头的哈希，所以单独下载区块头，也能得到一条链。第二，同样是比特币网络上的节点，却可以分成全节点和轻客户端两类，轻客户端就是只下载了区块头。第三，SPV 解决的就是在轻客户端中去确认单独一个交易的过程，总体思路是去相邻的全节点中去请求部分 Merkle 树信息，到本地验证通过，就证明其他的全节点都接受了这个交易。第四，SPV 是开发钱包软件和侧链的关键技术，意义非常重大。

参考：

- https://www.jianshu.com/p/39be41dfb5fa 
- https://bitcoin.org/en/full-node
- https://bitcoin.org/bitcoin.pdf
- https://en.bitcoin.it/wiki/Block
- https://en.bitcoin.it/wiki/Block_hashing_algorithm
- https://www.tangshuang.net/4117.html
